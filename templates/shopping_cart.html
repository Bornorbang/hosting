{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Domain Registration{% endblock %}
{% block description %}Complete your domain registration and explore our hosting products and services.{% endblock %}

{% block content %}
<!-- Shopping Cart Banner -->
<section class="bg-gray-900 text-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold mb-3">Shopping Cart</h1>
            <p class="text-base text-gray-300">Complete your domain registration and add hosting services</p>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-12 bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Sidebar - Categories -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-5 sticky top-4">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Categories</h2>
                    
                    <div class="space-y-4">
                        <!-- Domains -->
                        <div class="border-b border-gray-200 pb-3">
                            <h3 class="font-semibold text-gray-900 mb-2 text-sm">Domains</h3>
                            <ul class="space-y-1">
                                <li>
                                    <a href="{% url 'register_domain' %}" class="text-primary-600 hover:text-primary-800 text-xs transition duration-200">
                                        Domain Registration
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'transfer_domain' %}" class="text-primary-600 hover:text-primary-800 text-xs transition duration-200">
                                        Domain Transfer
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'whois_lookup' %}" class="text-primary-600 hover:text-primary-800 text-xs transition duration-200">
                                        WHOIS Lookup
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- Web Hosting -->
                        <div class="border-b border-gray-200 pb-3">
                            <h3 class="font-semibold text-gray-900 mb-3">Web Hosting</h3>
                            <ul class="space-y-2">
                                <li>
                                    <a href="{% url 'web_hosting' %}" class="text-primary-600 hover:text-primary-800 text-sm transition duration-200">
                                        Web Hosting
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="text-primary-600 hover:text-primary-800 text-sm transition duration-200">
                                        WordPress Hosting
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="text-primary-600 hover:text-primary-800 text-sm transition duration-200">
                                        Cloud Hosting
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- Security -->
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3">Security</h3>
                            <ul class="space-y-2">
                                <li>
                                    <a href="{% url 'ssl_certificates' %}" class="text-primary-600 hover:text-primary-800 text-sm transition duration-200">
                                        SSL Certificates
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content - Domain Search and Results -->
            <div class="lg:col-span-3">
                <!-- Domain Search Section -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Register Domain</h2>
                        <p class="text-gray-600">Find your new domain name. Enter your name or keywords below to check availability.</p>
                    </div>

                    <!-- Domain Search Form -->
                    <form id="cart-domain-search-form" class="max-w-2xl mx-auto">
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    placeholder="Enter your domain name..." 
                                    class="w-full px-4 py-3 text-gray-900 rounded-lg border-2 border-gray-300 focus:border-primary-500 focus:outline-none text-base"
                                    id="cart-domain-search"
                                    name="domain"
                                    value="{{ search_domain|default:'' }}"
                                    required
                                >
                            </div>
                            <button 
                                type="submit"
                                id="cart-search-btn"
                                class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span id="cart-search-text">Search Domain</span>
                                <svg id="cart-search-spinner" class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Domain Search Results -->
                <div id="cart-search-results" class="{% if not domain_result %}hidden{% endif %}">
                    {% if domain_result %}
                        {% if domain_result.available %}
                            <!-- Available Domain -->
                            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-bold text-green-600">{{ domain_result.domain }} is available!</h3>
                                            <div class="text-2xl font-bold text-black mt-2">
                                                <span id="formatted-price" data-price="{{ domain_result.pricing.registration }}">â‚¦{{ domain_result.pricing.registration|floatformat:2 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-300">
                                            Add to Cart
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Unavailable Domain -->
                            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <div class="flex items-center mb-4">
                                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900">{{ domain_result.domain }} is not available</h3>
                                        <p class="text-gray-600">This domain is already registered. Try a different name or extension.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Domain Suggestions -->
                            {% if domain_suggestions %}
                            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-4">Alternative Suggestions</h3>
                                <div class="space-y-3">
                                    {% for suggestion in domain_suggestions %}
                                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:border-primary-300 transition duration-200">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="font-semibold text-gray-900">{{ suggestion.domain }}</div>
                                                <div class="text-sm font-bold text-black">
                                                    <span class="suggestion-price" data-price="{{ suggestion.price_ngn }}">â‚¦{{ suggestion.price_ngn|floatformat:2 }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 text-sm">
                                            Add to Cart
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>

                <!-- Suggested Domains Section (Always Shows) -->
                <div class="bg-white rounded-lg shadow-lg p-6" id="suggestions-section">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Suggested Domains</h3>
                        <div id="suggestions-loader" class="flex items-center text-gray-500">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading suggestions...
                        </div>
                    </div>
                    
                    <!-- Suggestions Table -->
                    <div id="suggestions-table" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-2 px-3 font-semibold text-gray-700 text-sm">Domain Name</th>
                                        <th class="text-right py-2 px-3 font-semibold text-gray-700 text-sm">Price</th>
                                        <th class="text-center py-2 px-3 font-semibold text-gray-700 text-sm">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="suggestions-tbody">
                                    <!-- Suggestions will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Load More Button -->
                        <div id="load-more-container" class="hidden text-center mt-6">
                            <button id="load-more-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 text-sm">
                                ðŸš€ Give me more suggestions!
                            </button>
                            <p class="text-xs text-gray-500 mt-2">Show 10 more domain extensions</p>
                        </div>
                    </div>
                    
                    <!-- No Suggestions Message -->
                    <div id="no-suggestions" class="hidden text-center py-8">
                        <div class="text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 4a7.962 7.962 0 016 2.709M3 9.709A7.962 7.962 0 019 7m0 0a7.962 7.962 0 016 2.709M9 7v10m6-10v10"></path>
                            </svg>
                            <p class="text-gray-600">No domain suggestions available at the moment.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format price with commas
    const priceElement = document.getElementById('formatted-price');
    if (priceElement) {
        const price = parseFloat(priceElement.dataset.price);
        const formattedPrice = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(price);
        priceElement.textContent = 'â‚¦' + formattedPrice;
    }

    // Format suggestion prices with commas
    const suggestionPrices = document.querySelectorAll('.suggestion-price');
    suggestionPrices.forEach(function(element) {
        const price = parseFloat(element.dataset.price);
        const formattedPrice = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(price);
        element.textContent = 'â‚¦' + formattedPrice;
    });

    // Load TLD suggestions asynchronously  
    loadTldSuggestions();
    
    // Global variables for pagination
    let allSuggestions = [];
    let displayedSuggestions = 0;
    const suggestionsPerPage = 10;

    const form = document.getElementById('cart-domain-search-form');
    const searchInput = document.getElementById('cart-domain-search');
    const searchBtn = document.getElementById('cart-search-btn');
    const searchText = document.getElementById('cart-search-text');
    const searchSpinner = document.getElementById('cart-search-spinner');

    // Check if we have URL parameters and populate search input
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('query');
    if (query && searchInput) {
        searchInput.value = query;
    }

    form.addEventListener('submit', function(e) {
        const domain = searchInput.value.trim();
        
        if (!domain) {
            e.preventDefault();
            showError('Please enter a domain name');
            return;
        }

        // Show loading state
        setLoadingState(true);
        
        // Update the form action to include URL parameters
        const newUrl = `/shopping-cart/?a=add&domain=register&query=${encodeURIComponent(domain)}`;
        window.location.href = newUrl;
        
        // Prevent default form submission since we're handling it manually
        e.preventDefault();
    });

    function setLoadingState(loading) {
        searchBtn.disabled = loading;
        if (loading) {
            searchText.textContent = 'Searching...';
            searchSpinner.classList.remove('hidden');
        } else {
            searchText.textContent = 'Search Domain';
            searchSpinner.classList.add('hidden');
        }
    }

    function showError(message) {
        alert(message);
    }

    function loadTldSuggestions() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('query');
        
        if (!query) {
            // No query provided, hide suggestions section
            document.getElementById('suggestions-section').style.display = 'none';
            return;
        }
        
        // Ensure query has proper format (add .com if no extension)
        const domain = query.includes('.') ? query : query + '.com';
        
        const loader = document.getElementById('suggestions-loader');
        const table = document.getElementById('suggestions-table');
        const tbody = document.getElementById('suggestions-tbody');
        const noSuggestions = document.getElementById('no-suggestions');
        const suggestionsTitle = document.querySelector('#suggestions-section h3');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');

        // Update title to indicate TLD suggestions
        if (suggestionsTitle) {
            suggestionsTitle.textContent = `Other Extensions for "${domain.split('.')[0]}"`;
        }

        // Show loader
        loader.classList.remove('hidden');
        table.classList.add('hidden');
        noSuggestions.classList.add('hidden');
        loadMoreContainer.classList.add('hidden');
        
        // Reset pagination variables
        allSuggestions = [];
        displayedSuggestions = 0;

        fetch(`/api/tld-suggestions/?domain=${encodeURIComponent(domain)}`)
            .then(response => response.json())
            .then(data => {
                loader.classList.add('hidden');
                
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    // Store all suggestions for pagination
                    allSuggestions = data.suggestions;
                    
                    // Display first batch
                    displaySuggestions();
                } else {
                    // Show no suggestions message
                    noSuggestions.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('TLD Suggestions error:', error);
                loader.classList.add('hidden');
                noSuggestions.classList.remove('hidden');
            });
    }
    
    function displaySuggestions() {
        // Get next batch of suggestions
        const nextBatch = allSuggestions.slice(displayedSuggestions, displayedSuggestions + suggestionsPerPage);
        
        // If this is the first batch, clear the table
        if (displayedSuggestions === 0) {
            tbody.innerHTML = '';
        }
        
        // Add suggestions to table
        nextBatch.forEach(suggestion => {
            const formattedPrice = new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(suggestion.price);

            // Different styling for available vs unavailable domains
            const availabilityIcon = suggestion.available ? 
                `<div class="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center mr-2">
                    <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>` :
                `<div class="w-5 h-5 bg-red-100 rounded-full flex items-center justify-center mr-2">
                    <svg class="w-3 h-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>`;

            const statusText = suggestion.available ? 'Available' : 'Taken';
            const statusClass = suggestion.available ? 'text-green-600 font-medium text-sm' : 'text-red-600 text-sm';
            const actionButton = suggestion.available ? 
                `<button class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1.5 px-3 rounded-md transition duration-300 text-xs" onclick="addToCart('${suggestion.domain}')">
                    Add to Cart
                </button>` :
                `<span class="text-gray-400 text-xs">Not Available</span>`;

            const row = document.createElement('tr');
            row.className = 'border-b border-gray-100 hover:bg-gray-50 transition duration-200';
            row.innerHTML = `
                <td class="py-3 px-3">
                    <div class="flex items-center">
                        ${availabilityIcon}
                        <div>
                            <div class="${statusClass}">${suggestion.domain}</div>
                            <div class="text-xs text-gray-500">${statusText}</div>
                        </div>
                    </div>
                </td>
                <td class="py-3 px-3 text-right">
                    ${suggestion.available ? 
                        `<span class="text-sm font-bold text-black">â‚¦${formattedPrice}</span>` :
                        `<span class="text-gray-400 text-xs">-</span>`
                    }
                </td>
                <td class="py-3 px-3 text-center">
                    ${actionButton}
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Update displayed count
        displayedSuggestions += nextBatch.length;
        
        // Show table and manage load more button
        table.classList.remove('hidden');
        
        if (displayedSuggestions < allSuggestions.length) {
            // More suggestions available
            loadMoreContainer.classList.remove('hidden');
            loadMoreBtn.textContent = `ðŸš€ Give me more suggestions! (${allSuggestions.length - displayedSuggestions} remaining)`;
        } else {
            // All suggestions displayed
            loadMoreContainer.classList.add('hidden');
        }
    }
    
    // Load more suggestions event listener
    document.getElementById('load-more-btn').addEventListener('click', function() {
        displaySuggestions();
    });

    function addToCart(domain) {
        // TODO: Implement add to cart functionality
        alert(`Adding ${domain} to cart...`);
    }
});
</script>
{% endblock %}